name: Sync Secrets

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Preview mode - no secrets will be written'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  push:
    branches: [main]
    paths:
      - '.github/workflows/sync-secrets.yml'
      - 'secrets-config.yml'

permissions:
  contents: read

jobs:
  load-config:
    name: "Load Configuration"
    runs-on: ubuntu-latest
    outputs:
      secrets: ${{ steps.process-config.outputs.secrets }}
    steps:
      - uses: actions/checkout@v4

      - name: Process configuration
        id: process-config
        run: |
          set -euo pipefail

          OWNER="${{ github.repository_owner }}"
          PROFILE_REPO="$OWNER"

          # Convert YAML to JSON, then process with jq
          PROCESSED=$(yq eval -o=json '.secrets' secrets-config.yml | jq -c \
            --arg owner "$OWNER" \
            --arg profile "$PROFILE_REPO" \
            'map({
              name: .name,
              repositories: .repositories,
              repositories_formatted: (
                .repositories
                | map(if . == "__SELF__" then ($owner + "/" + $profile) else ($owner + "/" + .) end)
                | join("\n")
              )
            })')

          echo "secrets=$PROCESSED" >> $GITHUB_OUTPUT

  sync-secrets:
    name: "Sync ${{ matrix.secret.name }}"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        secret: ${{ fromJSON(needs.load-config.outputs.secrets) }}
      fail-fast: false  # Continue even if one secret fails
    needs: load-config
    steps:
      - uses: jpoehnelt/secrets-sync-action@7840777f242539d96b60477b66aa1c179e7644ea
        with:
          SECRETS: |
            ^${{ matrix.secret.name }}$
          REPOSITORIES: |
            ${{ matrix.secret.repositories_formatted }}
          REPOSITORIES_LIST_REGEX: false
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT_SECRETS_SYNC_ACTION }}
        env:
          ${{ matrix.secret.name }}: ${{ secrets[matrix.secret.name] }}
